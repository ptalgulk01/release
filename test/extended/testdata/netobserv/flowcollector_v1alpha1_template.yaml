apiVersion: template.openshift.io/v1
kind: Template
metadata:
  name: FlowCollector-template
objects:
  - apiVersion: flows.netobserv.io/v1alpha1
    kind: FlowCollector
    metadata:
      name: cluster
    spec:
      namespace: "${NAMESPACE}"
      deploymentModel: "${DEPLOYMENT_MODEL}"
      agent:
        type: EBPF
        ipfix:
          cacheActiveTimeout: 20s
          cacheMaxFlows: 400
          sampling: 400
          clusterNetworkOperator:
            namespace: openshift-network-operator
          ovnKubernetes:
            namespace: ovn-kubernetes
            daemonSetName: ovnkube-node
            containerName: ovnkube-node
        ebpf:
          image: "${EBPF_IMAGE}"
          imagePullPolicy: IfNotPresent
          sampling: 50
          cacheActiveTimeout: 5s
          cacheMaxFlows: 100000
          interfaces: [ ]
          excludeInterfaces: ["lo"]
          logLevel: info
          privileged: false
          resources:
            requests:
              memory: 50Mi
              cpu: 100m
            limits:
              memory: 100Mi
          kafkaBatchSize: 10485760
      processor:
        port: 2055
        image: "${FLOWLOGSPIPELINE_IMAGE}"
        imagePullPolicy: IfNotPresent
        logLevel: trace
        enableKubeProbes: true
        healthPort: 8080
        profilePort: 6060
        metrics:
          server:
            port: 9102
            tls:
              type: "${METRIC_SERVER_TLS_TYPE}"
          ignoreTags:
            - egress
            - packets
        dropUnusedFields: true
        resources:
          requests:
            memory: 100Mi
            cpu: 100m
          limits:
            memory: 300Mi
        kafkaConsumerReplicas: 3
        kafkaConsumerAutoscaler: null
        kafkaConsumerQueueCapacity: 1000
        kafkaConsumerBatchSize: 10485760
      kafka:
        address: "kafka-cluster-kafka-bootstrap.netobserv"
        topic: "network-flows"
        tls:
          enable: false
          caCert:
            type: secret
            name: kafka-cluster-cluster-ca-cert
            certFile: ca.crt
          userCert:
            type: secret
            name: flp-kafka
            certFile: user.crt
            certKey: user.key
      loki:
        url: "${LOKI_URL}"
        batchWait: 1s
        batchSize: 10485760
        minBackoff: 1s
        maxBackoff: 5s
        maxRetries: 2
        staticLabels:
          app: netobserv-flowcollector
        tls:
          enable: false
          caCert:
            type: configmap
            name: openshift-service-ca.crt
            certFile: service-ca.crt
      consolePlugin:
        register: true
        image: "${CONSOLEPLUGIN_IMAGE}"
        imagePullPolicy: IfNotPresent
        port: 9001
        logLevel: info
        autoscaler: null
        portNaming:
          enable: true
          portNames:
            "3100": loki
parameters:
  - name: NAMESPACE
    description: "namespace where you want flowlogsPipeline and consoleplugin pods to be deployed"
    value: "netobserv"
  - name: FLOWLOGSPIPELINE_IMAGE
    value: 'quay.io/netobserv/flowlogs-pipeline:main'
    required: true
  - name: CONSOLEPLUGIN_IMAGE
    value: 'quay.io/netobserv/network-observability-console-plugin:main'
    required: true
  - name: EBPF_IMAGE
    value: 'quay.io/netobserv/netobserv-ebpf-agent:main'
    required: true
  - name: METRIC_SERVER_TLS_TYPE
    value: "DISABLED"
  - name: LOKI_URL
    value: 'http://loki.netobserv.svc:3100/'
  - name: DEPLOYMENT_MODEL
    value: "DIRECT"
