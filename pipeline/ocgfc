#!/bin/bash
set +x
#get fail case from existing launch for rerun

WORKBUILDDIR=$1
WORKSPACE=$2
LAUNCHID=$3
ORIGSCENARIO="$4"

cd ${WORKBUILDDIR}
rm -fr reportportal.py && eval cp -fr ${WORKSPACE}"/private/pipeline/reportportal.py" .

rpmmtoken=`cat ${WORKSPACE}"/private/secrets/rp/openshift-qe-reportportal.json" | jq  -r ".ginkgo_rp_mmtoken"`
rppmtoken=`cat ${WORKSPACE}"/private/secrets/rp/openshift-qe-reportportal.json" | jq  -r ".ginkgo_rp_pmtoken"`
ret=`python3 reportportal.py -a getfcd -l "${LAUNCHID}" -ss "${ORIGSCENARIO}" -t "${rpmmtoken}" -ta "${rppmtoken}" 2>&1 || true`
# echo -e "\\\n"${ret}"\\\n"

result=`echo -e ${ret} | tail -1|xargs`
if [[ "$result" == *"-NOREPLACE" ]]; then
  failcaseid="NOREPLACE"
elif [[ "$result" == *"-NORERUN" ]]; then
  failcaseid="NORERUN"
else
  failcaseid="${result}"
fi
echo -e "Start\\\n"${ret}"\\\nthe last line:\\\n"${failcaseid}

set -x
